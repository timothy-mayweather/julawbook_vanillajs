<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Julawbook</title>
  <!-- Julaw favicon -->
  <link rel="icon" href="images/julaw.png" type="image/x-icon" style="border-radius: 15px">
  <!-- Styles -->
  <link rel="stylesheet" href="interface/admin/plugins/bootstrap-5.0.2-dist/css/bootstrap.min.css">
</head>
<body class="font-sans antialiased bg-light">
<div class="container">
  <div class="row justify-content-center my-5">
    <div class="col-sm-12 col-md-8 col-lg-5 my-5">
      <div class="d-flex justify-content-center mb-3">
        <a href="#welcome" class="app-form-link">
          <svg viewBox="0 0 316 316" xmlns="http://www.w3.org/2000/svg" width="82">
            xmlns:svg="http://www.w3.org/2000/svg"
            xmlns="http://www.w3.org/2000/svg"
            <image width="100%" height="100%" href="images/julaw.png" x="0" y="0" id="image10" preserveAspectRatio="none"></image>
          </svg>
        </a>
      </div>
      <div class="card shadow-sm px-3">
        <div class="card-body">
          <div id="welcome" hidden>
            <form method="POST" action="/branch" onsubmit="submitForm(event,this);">
              <!-- Validation Errors -->
              <div class="alert alert-danger mb-4" role="alert" hidden>
                <div class="text-danger">Whoops! Something went wrong.</div>
                <ul></ul>
              </div>
              <h3>Register branch (Please don't forget name and key)</h3>
              <!-- Name -->
              <div class="mb-3">
                <label>Name</label>
                <input class="form-control" type="text" name="name" required="required" autofocus="autofocus">
              </div>

              <!-- Location -->
              <div class="mb-3">
                <label>Location</label>
                <input class="form-control" type="text" name="location" required="required" autofocus="autofocus">
              </div>

              <!-- Password -->
              <div class="mb-3">
                <label>Key (Branch password)</label>
                <input class="form-control" type="password" name="password" required="required" autocomplete="new-password">
              </div>

              <!-- Confirm Password -->
              <div class="mb-3">
                <label>Confirm Key</label>
                <input class="form-control" type="password" name="password_confirmation" required="required">
              </div>

              <div class="d-flex items-center justify-content-end mt-4">
                <button type="submit" class="btn btn-dark ml-4">Register Branch</button>
              </div>
            </form>
            <div class="d-flex items-center justify-content-end mt-4 bold">
              For users of registered branch only
            </div>
            <div class="d-flex items-center justify-content-end mt-4">
            <div>
              <a href="#login" class="me-3 app-form-link"><button type="button" class="btn btn-dark ml-4">Log in</button></a>
              <a href="#register" class="me-3 app-form-link"><button type="button" class="btn btn-dark ml-4">Register</button></a>
            </div>
          </div>
          </div>
          <div id="register" hidden>
            <form method="POST" action="/register" onsubmit="submitForm(event,this);">
              <div class="alert alert-success mb-4" role="alert">
                <div class="text-success">You will first be approved by your manager before logging in the first time.</div>
              </div>
              <!-- Validation Errors -->
              <div class="alert alert-danger mb-4" role="alert" hidden>
                <div class="text-danger">Whoops! Something went wrong.</div>
                <ul></ul>
              </div>
              <div class="mb-3">
                <label>Name</label>
                <input class="form-control" type="text" name="name" required="required" autofocus="autofocus">
              </div>

              <!-- Phone -->
              <div class="mb-3">
                <label>Phone</label>
                <input class="form-control" type="text" name="phone" required="required" autofocus="autofocus">
              </div>

              <!-- Email Address -->
              <div class="mb-3">
                <label>Email</label>
                <input class="form-control" type="email" name="email" required="required">
              </div>

              <!-- Password -->
              <div class="mb-3">
                <label>Password</label>
                <input class="form-control" type="password" name="password" required="required" autocomplete="new-password">
              </div>

              <!-- Confirm Password -->
              <div class="mb-3">
                <label>Confirm Password</label>
                <input class="form-control" type="password" name="password_confirmation" required="required">
              </div>

              <!-- Branch -->
              <div class="mb-3">
                <label for="branch">Branch</label>
                <select style="cursor: pointer" class="form-select" id="branch" name="branch" required="required"></select>
              </div>

              <div class="mb-0">
                <div class="d-flex justify-content-end align-items-baseline">
                  <a class="text-muted me-3 text-decoration-underline app-form-link" href="#login">Already registered?</a>
                  <button type="submit" class="btn btn-dark">Register</button>
                </div>
              </div>
            </form>
          </div>
          <div id="login" hidden>
            <div class="d-flex justify-content-end align-items-baseline mt-2">
              <p class="me-3" style="font-size: 25px">Login or </p><a href="#register" class="app-form-link"><button type="submit" class="btn btn-dark ml-4">
              Register
            </button>
            </a>
            </div>
            <form method="POST" action="/login" onsubmit="login(event,this);">
              <!-- Validation Errors -->
              <div class="alert alert-danger mb-4" role="alert" hidden>
                <div class="text-danger">Whoops! Something went wrong.</div>
                <ul></ul>
              </div>
              <!-- Email Address -->
              <div class="mb-3">
                <label>Email</label>
                <input class="form-control" type="email" name="email" required="required" autofocus="autofocus">
              </div>

              <!-- Password -->
              <div class="mb-3">
                <label>Password</label>
                <input class="form-control" type="password" name="password" required="required" autocomplete="current-password">
              </div>

              <!-- Remember Me -->
              <div class="mb-3">
                <div class="form-check">
                  <input type="checkbox" class="form-check-input" id="remember_me" name="remember">
                  <label class="form-check-label" for="remember_me">Remember Me</label>
                </div>
              </div>

              <div class="mb-0">
                <div class="d-flex justify-content-end align-items-baseline">
                  <a class="text-muted me-3 app-form-link" href="#forgot-password">Forgot your password?</a>
                  <button type="submit" class="btn btn-dark">Log in</button>
                </div>
              </div>
            </form>
          </div>
          <div id="forgot-password" hidden>
            <div class="mb-4">
              Forgot your password? No problem. Just let us know your email
              address and we will email you a password reset link that will allow you
              to choose a new one.
            </div>
            <div class="card-body">
              <form method="POST" action="http://127.0.0.1:8000/forgot-password">
                <!-- Email Address -->
                <div class="mb-3">
                  <label>Email</label>
                  <input class="form-control" type="email" name="email" required="required" autofocus="autofocus">
                </div>

                <div class="d-flex justify-content-end mt-4">
                  <button type="submit" class="btn btn-dark">Email Password Reset Link</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  let activeForm = "";
  sessionStorage.setItem('address','http://127.0.0.1:8000/api');
  let address = sessionStorage.getItem('address');

  function getBranches() {
    fetch(address+'/branch',{method:'get', body: null})
      .then((response)=>response.json())
      .then((data)=>{
        if(data.length>0) {
          let html = "";
          const branch = document.getElementById("branch");
          for(let i=0; i<data.length; i++){
            html += "<option value='"+data[i]['id']+"'>"+data[i]["name"]+"</option>"
          }
          branch.innerHTML = html;
          branch.value = "";
        }
      });
  }
  getBranches();

  function changeView(newView){
    document.getElementById(activeForm).hidden = true;
    activeForm = newView;
    document.getElementById(activeForm).hidden = false;
    document.title = activeForm;
  }

  function submitForm(event,form){
    event.preventDefault();
    fetch(address+form.getAttribute("action"),{method:form.method, body: new FormData(form)})
      .then((response)=>response.json())
      .then((data)=>{
        if(data.hasOwnProperty('redirect')) {
            window.location.href = data["redirect"];
            changeView(data["redirect"].substring(1))
        }
        else{
          let errorDiv = form.querySelector("div .alert-danger");
          let errorList = errorDiv.querySelector("ul");
          errorDiv.hidden = false;
          errorList.innerHTML="";
          for(let key in data){
            errorList.innerHTML+="<li>"+data[key][0]+"</li>";
          }
        }
      });
  }

  function login(event,form){
    event.preventDefault();
    fetch(address+form.getAttribute("action"),{method:form.method, body: new FormData(form)})
      .then((response)=>response.json())
      .then((data)=>{
        if(data.hasOwnProperty('redirect')) {
          sessionStorage.setItem('token',data['token']);
          sessionStorage.setItem('branch_name',data['branch_name']);
          sessionStorage.setItem('branch_id',data['branch_id']);
          sessionStorage.setItem('name',data['name']);
          sessionStorage.setItem('user_role',data['manager']==="Yes"?"manager":"attendant");
          window.location.href = data["redirect"];
        }
        else {
          let errorDiv = form.querySelector("div .alert-danger");
          let errorList = errorDiv.querySelector("ul");
          errorDiv.hidden = false;
          errorList.innerHTML="";
          for(let key in data){
            errorList.innerHTML+="<li>"+data[key][0]+"</li>";
          }
        }
      });
  }

  (function (){
    activeForm = window.location.href;
    const hashIndex = activeForm.indexOf('#');
    activeForm = (hashIndex>-1)? activeForm.slice(hashIndex+1) : "welcome";
    document.getElementById(activeForm).hidden = false;
    document.title = activeForm;

    const appFormLinks = document.getElementsByClassName("app-form-link");
    for(let i=0; i<appFormLinks.length; i++) {
      if (appFormLinks[i].getAttribute("href") === "#register") {
        appFormLinks[i].addEventListener("click", function () {
          changeView(this.getAttribute("href").substring(1));
          getBranches();
        });
      } else {
        appFormLinks[i].addEventListener("click", function () {
          changeView(this.getAttribute("href").substring(1));
        });
      }
    }
  })();
</script>
</body>
</html>
